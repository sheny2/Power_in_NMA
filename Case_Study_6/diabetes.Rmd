---
title: "Smoke_Result"
author: "Yicheng Shen"
date: "2023-06-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gemtc)
```


This network meta-analysis is reported by Elliott and Meyer (2007) to assess the effects of antihypertensive agents on incident diabetes. Treatment IDs represent 1) diuretic; 2) placebo; 3) beta-blocker; 4) calcium-channel blocker (CCB); 5) angiotensin-converting-enzyme (ACE) inhibitor;
and 6) angiotensin-receptor blocker (ARB).

```{r, fig.height=7, fig.width=10}
library(pcnetmeta)
data(diabetes)

diabetes_ab = data.frame(study = factor(diabetes$s.id), treatment = factor(diabetes$t.id), 
                         sampleSize = diabetes$n, responders = diabetes$r)

network <- mtc.network(diabetes_ab)
plot(network)

nma.networkplot(study, treatment, data = diabetes_ab, 
                title = "Incident Diabetes", node.col = "orange", edge.col = "gray", adjust.thick = 10,
                trtname = c("1: diuretic", 
                            "2: placebo", 
                            "3: Î²-blocker", 
                            "4: CCB","5: ACE", "6: ARB"))

nma.networkplot(study, treatment, data = diabetes_ab, title = "Incident Diabetes", node.col = "orange",  
                edge.col = "gray", adjust.thick = 10)

```

5-6
2-4
1-3
3-4


```{r}
cons.model <- mtc.model(network, type="consistency", likelihood="binom", link="logit", linearModel="random")
cons.out <- mtc.run(cons.model, n.adapt=20000, n.iter=30000, thin=1)
summary(cons.out)
gemtc::forest(cons.out)
```



```{r}
diabetes_eff = data.frame(sid = as.numeric(diabetes_ab$study), 
                          tid = as.numeric(diabetes_ab$treatment), 
                       r = diabetes_ab$responders, n = diabetes_ab$sampleSize)
library("igraph")
source("functions.R")
dir.binary(diabetes_eff)
eff.binary(diabetes_eff)
```





```{r}
load("result_diabetes_original.RData")
result_diabetes_all = result_diabetes %>% data.frame()
load("result_diabetes_AB.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())
load("result_diabetes_AC.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())
load("result_diabetes_AD.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())
load("result_diabetes_AE.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())
load("result_diabetes_AF.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())
load("result_diabetes_EF.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())


result_diabetes_all = cbind(c("Original", "Add one AB study", "Add one AC study", "Add one AD study", "Add one AE study","Add one AF study","Add one EF study"), result_diabetes_all)

colnames(result_diabetes_all) <- c("Modification",
                                    "Power AB","Power AC","Power AD",
                                    "Power AE","Power AF")
result_diabetes_all


result_diabetes_all %>%
  mutate(Modification = factor(
    Modification,
    levels = c(
      "Original",
      "Add one AB study",
      "Add one AC study",
      "Add one AD study",
      "Add one AE study",
      "Add one AF study",
      "Add one EF study"
    )
  )) %>%
  pivot_longer(cols = 2:6,
               names_to = "Comparison",
               values_to = "Power") %>%
  ggplot() + geom_col(
    aes(x = Comparison, y = Power, fill = Modification),
    position = position_dodge(0.8),
    width = 0.75
  )  + labs(x = " ")
```

```{r}
load("result_diabetes_4power_original.RData")
result_diabetes_all = result_diabetes %>% data.frame()

load("result_diabetes_4power_add56one.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())

load("result_diabetes_4power_add24one.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())

load("result_diabetes_4power_add13one.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())

load("result_diabetes_4power_add34one.RData")
result_diabetes_all = rbind(result_diabetes_all, 
                                 result_diabetes %>% data.frame())


result_diabetes_all = cbind(c("Original", "Add one 56 study", "Add one 24 study", "Add one 13 study", "Add one 34 study"), result_diabetes_all)

colnames(result_diabetes_all) <- c("Modification",
                                    "Power 5-6","Power 2-4","Power 1-3","Power 3-4")
# result_diabetes_all


result_diabetes_all %>%
  mutate(Modification = factor(
    Modification,
    levels = c( "Original", "Add one 56 study", "Add one 24 study", "Add one 13 study", "Add one 34 study")
  )) %>%
  pivot_longer(cols = 2:5,
               names_to = "Comparison",
               values_to = "Power") %>%
  mutate(Comparison = factor(
    Comparison,
    levels = c("Power 5-6","Power 2-4","Power 1-3","Power 3-4")
  )) %>% 
  ggplot() + geom_col(
    aes(x = Comparison, y = Power, fill = Modification),
    position = position_dodge(0.8),
    width = 0.75
  )  + labs(x = " ")
```
