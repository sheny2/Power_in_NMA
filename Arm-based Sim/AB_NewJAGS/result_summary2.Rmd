---
title: "Result"
author: "Yicheng Shen"
date: "2024-1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = F, warning = F, eval = T, message = F)
library(tidyverse)
library(kableExtra)
library(latex2exp)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(out.width = "100%", fig.align = 'center')
```


# tau 0.4 
# 18 studies

```{r}
load("result_four_model_tau_0.4.RData")

result_four_model = result_four_model %>% data.frame()
result_four_model$index = rep(1:S, each = 38)

result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% ggplot() + geom_boxplot(aes(Model, DIC, color = Model)) 
result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% mutate(index = 1:S) %>% ggplot() + geom_point(aes(index, DIC, color = Model))



result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% 
  group_by(index) %>% 
  mutate(order = rank(DIC, ties.method = "min")) %>% 
  ggplot(aes(factor(order), fill = Model)) +
  geom_bar(position = "fill", color = "Black") +
  geom_text(aes(x = factor(order), 
                label = scales::percent(after_stat(count / tapply(count, x, sum)[x]), accuracy = 0.01), 
                group = Model), size = 3, position = position_fill(vjust = 0.5), stat = "count") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "DIC ranking (1 meaning lowest)", y = "proportion", title = "Model DIC ranking")


# 
# result_four_model %>% filter(Model == "AB_het_eqcor")
# result_four_model %>% filter(Model == "AB_homo_eqcor")


# tau for LA
result_four_model %>% filter(Model == "LA_results", drug_list == "tau") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = 0.4)


# OR_ab
result_four_model %>% filter(drug_list == "or[2]") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = OR_ab) + 
  facet_wrap(~Model)


# OR_ac
result_four_model %>% filter(drug_list == "or[3]") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = OR_ac) + 
  facet_wrap(~Model)


```
# 12 studies

```{r}
load("result_four_model_tau_12_study.RData")

result_four_model = result_four_model %>% data.frame()
result_four_model$index = rep(1:S, each = 38)

result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% ggplot() + geom_boxplot(aes(Model, DIC, color = Model)) 
result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% mutate(index = 1:S) %>% ggplot() + geom_point(aes(index, DIC, color = Model))



result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% 
  group_by(index) %>% 
  mutate(order = rank(DIC, ties.method = "min")) %>% 
  ggplot(aes(factor(order), fill = Model)) +
  geom_bar(position = "fill", color = "Black") +
  geom_text(aes(x = factor(order), 
                label = scales::percent(after_stat(count / tapply(count, x, sum)[x]), accuracy = 0.01), 
                group = Model), size = 3, position = position_fill(vjust = 0.5), stat = "count") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "DIC ranking (1 meaning lowest)", y = "proportion", title = "Model DIC ranking")


# 
# result_four_model %>% filter(Model == "AB_het_eqcor")
# result_four_model %>% filter(Model == "AB_homo_eqcor")


# tau for LA
result_four_model %>% filter(Model == "LA_results", drug_list == "tau") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = 0.4)


# OR_ab
result_four_model %>% filter(drug_list == "or[2]") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = OR_ab) + 
  facet_wrap(~Model)


# OR_ac
result_four_model %>% filter(drug_list == "or[3]") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = OR_ac) + 
  facet_wrap(~Model)


```

# 6 studies

```{r}
load("result_four_model_tau_6_study.RData")

result_four_model = result_four_model %>% data.frame()
result_four_model$index = rep(1:S, each = 38)

result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% ggplot() + geom_boxplot(aes(Model, DIC, color = Model)) 
result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% mutate(index = 1:S) %>% ggplot() + geom_point(aes(index, DIC, color = Model))



result_four_model %>% filter(drug_list == "deviance") %>% group_by(Model) %>% 
  group_by(index) %>% 
  mutate(order = rank(DIC, ties.method = "min")) %>% 
  ggplot(aes(factor(order), fill = Model)) +
  geom_bar(position = "fill", color = "Black") +
  geom_text(aes(x = factor(order), 
                label = scales::percent(after_stat(count / tapply(count, x, sum)[x]), accuracy = 0.01), 
                group = Model), size = 3, position = position_fill(vjust = 0.5), stat = "count") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "DIC ranking (1 meaning lowest)", y = "proportion", title = "Model DIC ranking")


# 
# result_four_model %>% filter(Model == "AB_het_eqcor")
# result_four_model %>% filter(Model == "AB_homo_eqcor")


# tau for LA
result_four_model %>% filter(Model == "LA_results", drug_list == "tau") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = 0.4)


# OR_ab
result_four_model %>% filter(drug_list == "or[2]", mean < 100) %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = OR_ab) + 
  facet_wrap(~Model)


# OR_ac
result_four_model %>% filter(drug_list == "or[3]", mean < 100) %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) + 
  geom_hline(yintercept = OR_ac) + 
  facet_wrap(~Model)


```



```{r}
load("result_four_model_tau_0.4.RData")
result_four_model = result_four_model %>% data.frame()
result_four_model$index = rep(1:S, each = 38)
result_four_model_18 = result_four_model
load("result_four_model_tau_12_study.RData")
result_four_model = result_four_model %>% data.frame()
result_four_model$index = rep(1:S, each = 38)
result_four_model_12 = result_four_model
load("result_four_model_tau_6_study.RData")
result_four_model = result_four_model %>% data.frame()
result_four_model$index = rep(1:S, each = 38)
result_four_model_6 = result_four_model
```


```{r, fig.width=18, fig.height=5}
grid.arrange(
result_four_model_18 %>% filter(Model %in%  c("AB_het_eqcor",  "AB_homo_eqcor"), drug_list == "rho") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) +   
  labs(title = TeX("Est. $rho$ under 18 studies")) + 
  facet_wrap(~Model)
,
result_four_model_12 %>% filter(Model %in%  c("AB_het_eqcor",  "AB_homo_eqcor"), drug_list == "rho") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) +   
  labs(title = TeX("Est. $rho$ under 12 studies")) + 
  facet_wrap(~Model)
,
result_four_model_6 %>% filter(Model %in%  c("AB_het_eqcor",  "AB_homo_eqcor"), drug_list == "rho") %>% 
  ggplot() +   
  geom_point(aes(x = index, y = mean), size = 0.5)  + 
  geom_ribbon(aes(x = index, ymin = X2.5., ymax = X97.5.), alpha = 0.3) +   
  labs(title = TeX("Est. $rho$ under 6 studies")) + 
  facet_wrap(~Model)
, ncol = 3)
```


```{r, fig.width=18, fig.height=5}
grid.arrange(
result_four_model_18 %>% filter(drug_list == "deviance") %>% group_by(Model) %>% 
  group_by(index) %>% 
  mutate(order = rank(DIC, ties.method = "min")) %>% 
  ggplot(aes(factor(order), fill = Model)) +
  geom_bar(position = "fill", color = "Black") +
  geom_text(aes(x = factor(order), 
                label = scales::percent(after_stat(count / tapply(count, x, sum)[x]), accuracy = 0.01), 
                group = Model), size = 3, position = position_fill(vjust = 0.5), stat = "count") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "DIC ranking (1 meaning lowest)", y = "proportion", title = TeX("Model DIC ranking under 18 studies"))
,
result_four_model_12 %>% filter(drug_list == "deviance") %>% group_by(Model) %>% 
  group_by(index) %>% 
  mutate(order = rank(DIC, ties.method = "min")) %>% 
  ggplot(aes(factor(order), fill = Model)) +
  geom_bar(position = "fill", color = "Black") +
  geom_text(aes(x = factor(order), 
                label = scales::percent(after_stat(count / tapply(count, x, sum)[x]), accuracy = 0.01), 
                group = Model), size = 3, position = position_fill(vjust = 0.5), stat = "count") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "DIC ranking (1 meaning lowest)", y = "proportion", title = TeX("Model DIC ranking under 12 studies"))
,
result_four_model_6 %>% filter(drug_list == "deviance") %>% group_by(Model) %>% 
  group_by(index) %>% 
  mutate(order = rank(DIC, ties.method = "min")) %>% 
  ggplot(aes(factor(order), fill = Model)) +
  geom_bar(position = "fill", color = "Black") +
  geom_text(aes(x = factor(order), 
                label = scales::percent(after_stat(count / tapply(count, x, sum)[x]), accuracy = 0.01), 
                group = Model), size = 3, position = position_fill(vjust = 0.5), stat = "count") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "DIC ranking (1 meaning lowest)", y = "proportion", title = TeX("Model DIC ranking under 6 studies"))
, ncol = 3)
```


```{r, fig.width=18, fig.height=5}
grid.arrange(
result_four_model_18 %>% filter(drug_list == "or[2]") %>% 
  mutate(bias = abs(mean-OR_ab)) %>% 
  ggplot() + geom_boxplot(aes(Model, bias, color = Model))  + ylim(0,2),
result_four_model_12 %>% filter(drug_list == "or[2]") %>% 
  mutate(bias = abs(mean-OR_ab)) %>% 
  ggplot() + geom_boxplot(aes(Model, bias, color = Model))  + ylim(0,2),
result_four_model_6 %>% filter(drug_list == "or[2]") %>% 
  mutate(bias = abs(mean-OR_ab)) %>% 
  ggplot() + geom_boxplot(aes(Model, bias, color = Model))  + ylim(0,100)
, ncol = 3)


grid.arrange(
result_four_model_18 %>% filter(drug_list == "or[3]") %>% 
  mutate(bias = abs(mean-OR_ab)) %>% 
  ggplot() + geom_boxplot(aes(Model, bias, color = Model))  + ylim(0,3),
result_four_model_12 %>% filter(drug_list == "or[3]") %>% 
  mutate(bias = abs(mean-OR_ab)) %>% 
  ggplot() + geom_boxplot(aes(Model, bias, color = Model))  + ylim(0,3),
result_four_model_6 %>% filter(drug_list == "or[3]") %>% 
  mutate(bias = abs(mean-OR_ab)) %>% 
  ggplot() + geom_boxplot(aes(Model, bias, color = Model))  + ylim(0,100)
, ncol = 3)
```